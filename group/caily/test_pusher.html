<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pusher Notification Test</title>
    <script>
        // Mock user data for testing
        window.USER_ID = 'test_user';
        window.USER_ROLE = 'administrator';
    </script>
</head>
<body>
    <h1>Pusher Notification System Test</h1>
    <p>This page tests the real-time notification system using Pusher.</p>
    <p>Open this page in multiple tabs to see notifications in action.</p>
    
    <div>
        <h3>Test Buttons:</h3>
        <button onclick="testRequestCreated()">Test Request Created</button>
        <button onclick="testRequestUpdated()">Test Request Updated</button>
        <button onclick="testRequestApproved()">Test Request Approved</button>
        <button onclick="testRequestRejected()">Test Request Rejected</button>
        <button onclick="testCommentAdded()">Test Comment Added</button>
        <button onclick="testProjectUpdated()">Test Project Updated</button>
        <button onclick="testTaskUpdated()">Test Task Updated</button>
        <button onclick="testTimeEntryUpdated()">Test Time Entry Updated</button>
        <button onclick="testServerNotification()">Test Server Notification</button>
    </div>

    <div>
        <h3>Connection Status:</h3>
        <div id="connection-status">Connecting...</div>
    </div>

    <div>
        <h3>Configuration:</h3>
        <div id="config-status">Loading...</div>
    </div>

    <div>
        <h3>Received Events:</h3>
        <div id="events"></div>
    </div>

    <script src="/js/notification.js"></script>
    <script>
        // Update connection status
        function updateConnectionStatus(status, color) {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = status;
            statusDiv.style.color = color;
            console.log('Connection Status:', status);
        }

        // Update config status
        function updateConfigStatus(status, color) {
            const configDiv = document.getElementById('config-status');
            configDiv.innerHTML = status;
            configDiv.style.color = color;
            console.log('Config Status:', status);
        }

        // Add event to the events list
        function addEvent(event) {
            const eventsDiv = document.getElementById('events');
            const eventDiv = document.createElement('div');
            eventDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${JSON.stringify(event)}`;
            eventDiv.style.border = '1px solid #ccc';
            eventDiv.style.padding = '10px';
            eventDiv.style.margin = '5px 0';
            eventsDiv.appendChild(eventDiv);
            console.log('Event received:', event);
        }

        // Override notification manager to show events and add more logging
        const originalHandleEvent = NotificationManager.prototype.handleEvent;
        NotificationManager.prototype.handleEvent = function(event) {
            console.log('NotificationManager.handleEvent called with:', event);
            addEvent(event);
            return originalHandleEvent.call(this, event);
        };

        // Override loadPusherConfig to add logging
        const originalLoadPusherConfig = NotificationManager.prototype.loadPusherConfig;
        NotificationManager.prototype.loadPusherConfig = async function() {
            console.log('Loading Pusher configuration...');
            try {
                const response = await fetch('/api/NotificationAPI.php?action=config');
                console.log('Config response status:', response.status);
                
                if (response.ok) {
                    const config = await response.json();
                    console.log('Pusher config received:', config);
                    updateConfigStatus('‚úÖ Config loaded: ' + JSON.stringify(config), 'green');
                    
                    this.pusherConfig = {
                        key: config.key,
                        cluster: config.cluster,
                        authEndpoint: '/api/NotificationAPI.php?action=auth'
                    };
                    this.connectPusher();
                } else {
                    console.error('Failed to load Pusher configuration, status:', response.status);
                    updateConfigStatus('‚ùå Failed to load config (HTTP ' + response.status + ')', 'red');
                    
                    // Fallback to default config
                    this.pusherConfig = {
                        key: 'your_key',
                        cluster: 'ap1',
                        authEndpoint: '/api/NotificationAPI.php?action=auth'
                    };
                    this.connectPusher();
                }
            } catch (error) {
                console.error('Error loading Pusher configuration:', error);
                updateConfigStatus('‚ùå Config error: ' + error.message, 'red');
                
                // Fallback to default config
                this.pusherConfig = {
                    key: 'your_key',
                    cluster: 'ap1',
                    authEndpoint: '/api/NotificationAPI.php?action=auth'
                };
                this.connectPusher();
            }
        };

        // Override connection events with more logging
        const originalConnectPusher = NotificationManager.prototype.connectPusher;
        NotificationManager.prototype.connectPusher = function() {
            console.log('Connecting to Pusher with config:', this.pusherConfig);
            const result = originalConnectPusher.call(this);
            
            if (this.pusher) {
                this.pusher.connection.bind('connected', () => {
                    console.log('‚úÖ Pusher connected successfully');
                    updateConnectionStatus('‚úÖ Connected to Pusher', 'green');
                    
                    // Test if we can receive events immediately
                    setTimeout(() => {
                        console.log('üß™ Testing event reception...');
                        this.handleEvent({
                            type: 'test_event',
                            message: 'Local test event',
                            timestamp: new Date().toISOString()
                        });
                    }, 1000);
                });

                this.pusher.connection.bind('disconnected', () => {
                    console.log('‚ùå Pusher disconnected');
                    updateConnectionStatus('‚ùå Disconnected from Pusher', 'red');
                });

                this.pusher.connection.bind('error', (error) => {
                    console.error('‚ùå Pusher connection error:', error);
                    updateConnectionStatus('‚ùå Pusher Connection Error: ' + error.message, 'red');
                });

                // Add logging for channel subscription
                if (this.channel) {
                    console.log('Subscribing to channel:', this.channel.name);
                    
                    // Test channel subscription
                    this.channel.bind('pusher:subscription_succeeded', () => {
                        console.log('‚úÖ Successfully subscribed to channel:', this.channel.name);
                    });
                    
                    this.channel.bind('pusher:subscription_error', (error) => {
                        console.error('‚ùå Channel subscription error:', error);
                    });
                    
                    // Override channel bind methods to add logging
                    const originalBind = this.channel.bind;
                    this.channel.bind = function(eventName, callback) {
                        console.log('Binding to event:', eventName);
                        return originalBind.call(this, eventName, function(data) {
                            console.log('üì® Received event:', eventName, 'with data:', data);
                            callback(data);
                        });
                    };
                }
            } else {
                console.error('Failed to create Pusher instance');
                updateConnectionStatus('‚ùå Failed to create Pusher instance', 'red');
            }
            
            return result;
        };

        // Test functions
        function testRequestCreated() {
            console.log('Testing request created event');
            const event = {
                type: 'request_created',
                request_id: 1,
                request_type: 'leave',
                user_id: 'other_user',
                timestamp: new Date().toISOString()
            };
            window.notificationManager.handleEvent(event);
        }

        function testRequestUpdated() {
            console.log('Testing request updated event');
            const event = {
                type: 'request_updated',
                request_id: 1,
                request_type: 'leave',
                status: 'pending',
                user_id: 'other_user',
                timestamp: new Date().toISOString()
            };
            window.notificationManager.handleEvent(event);
        }

        function testRequestApproved() {
            console.log('Testing request approved event');
            const event = {
                type: 'request_status_changed',
                request_id: 1,
                request_type: 'leave',
                status: 'approved',
                user_id: 'other_user',
                action_user: 'admin',
                action: 'approved',
                timestamp: new Date().toISOString()
            };
            window.notificationManager.handleEvent(event);
        }

        function testRequestRejected() {
            console.log('Testing request rejected event');
            const event = {
                type: 'request_status_changed',
                request_id: 1,
                request_type: 'leave',
                status: 'rejected',
                user_id: 'other_user',
                action_user: 'admin',
                action: 'rejected',
                timestamp: new Date().toISOString()
            };
            window.notificationManager.handleEvent(event);
        }

        function testCommentAdded() {
            console.log('Testing comment added event');
            const event = {
                type: 'request_comment_added',
                request_id: 1,
                request_type: 'leave',
                user_id: 'other_user',
                comment_user_id: 'admin',
                timestamp: new Date().toISOString()
            };
            window.notificationManager.handleEvent(event);
        }

        function testProjectUpdated() {
            console.log('Testing project updated event');
            const event = {
                type: 'project_updated',
                project_id: 1,
                project_name: 'Test Project',
                user_id: 'other_user',
                timestamp: new Date().toISOString()
            };
            window.notificationManager.handleEvent(event);
        }

        function testTaskUpdated() {
            console.log('Testing task updated event');
            const event = {
                type: 'task_updated',
                task_id: 1,
                task_name: 'Test Task',
                project_id: 1,
                user_id: 'other_user',
                timestamp: new Date().toISOString()
            };
            window.notificationManager.handleEvent(event);
        }

        function testTimeEntryUpdated() {
            console.log('Testing time entry updated event');
            const event = {
                type: 'time_entry_updated',
                task_id: 1,
                task_name: 'Test Task',
                user_id: 'other_user',
                timestamp: new Date().toISOString()
            };
            window.notificationManager.handleEvent(event);
        }

        // Test server-side notification
        async function testServerNotification() {
            console.log('Testing server-side notification');
            try {
                const response = await fetch('/api/NotificationAPI.php?action=trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        channel: 'notifications',
                        event: 'test_event',
                        data: JSON.stringify({
                            message: 'Test notification from server',
                            timestamp: new Date().toISOString()
                        })
                    })
                });
                
                const result = await response.json();
                console.log('Server notification result:', result);
                
                if (result.success) {
                    console.log('‚úÖ Server notification sent successfully');
                } else {
                    console.error('‚ùå Server notification failed:', result.error);
                }
            } catch (error) {
                console.error('‚ùå Error sending server notification:', error);
            }
        }

        // Add global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
        });

        // Log when page loads
        console.log('Test page loaded, USER_ID:', window.USER_ID, 'USER_ROLE:', window.USER_ROLE);
    </script>
</body>
</html> 